---
# CI Integration
image: python:3.7-buster

stages:
  - build

variables:
  SONAR_DEBUG: 1
  TESTS_DEBUG: 1

before_script:
  - apt-get update
  - apt-get install --yes -qqq zip

tests:
  stage: build
  before_script:
    - pip --cache-dir .pip install -r requirements.txt
    - pip --cache-dir .pip install -r requirements-tests.txt
  script: |
    export PYTHONPATH=${PYTHONPATH}:bump-release
    pytest --cov=bump_release ./tests
  cache:
    paths:
      - .pip/
  tags:
    - python3.6

# Check code quality against sonarqube
sonar:
  stage: build
  variables:
    SONAR_VERSION: 4.0.0.1744-linux
    SONAR_SCANNER_OPTS: "-Xmx512m"
    SONAR_HOST: "http://sonarqube.ville.tg/"
    SONAR_SCANNER_URL: https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_VERSION}.zip
  before_script:
    - apt-get update
    - apt-get install --yes -qqq openjdk-11-jdk-headless
    - pip --cache-dir .pip/ install pylint
    - test ${SONAR_DEBUG} -eq 1 && ls -la
    # Installs sonar-runner ZIP file
    - if [[ ! -d sonar-scanner-${SONAR_VERSION} ]]; then
    # yamllint disable-line rule:line-length
    - wget --no-verbose https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_VERSION}.zip
    # yamllint disable-line rule:max-spaces-ahter
    - unzip -q sonar-scanner-cli-${SONAR_VERSION}.zip
    - fi
  script: |
    sonar-scanner-${SONAR_VERSION}/bin/sonar-scanner --version
    # Runs the sonar-runner
    export SONAR_SCANNER_OPTS="-Xmx512m"
    if [[ ${SONAR_DEBUG} -eq 1 ]]; then
      sonar-scanner-${SONAR_VERSION}/bin/sonar-scanner -X -Dsonar.host.url=$SONAR_HOST
    else
      sonar-scanner-${SONAR_VERSION}/bin/sonar-scanner -Dsonar.host.url=$SONAR_HOST
    fi
  cache:
    paths:
      - sonar-scanner-${SONAR_VERSION}/
      - pip/
  tags:
    - python3.6
